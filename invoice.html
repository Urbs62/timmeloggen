    <!doctype html>
<html lang="sv">
<head>
  <link rel="stylesheet" href="styles.css" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Faktura – Jubrion AB</title>

  <style>
    :root{
      --text:#111; --muted:#555; --line:#ddd; --bg:#fff;
      --accent:#1e63d5; --r:12px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }
    html,body{ background:var(--bg); color:var(--text); font-family:var(--font); margin:0; }
    .page{ max-width: 900px; margin: 0 auto; padding: 24px; }

    /* ===== Actions (print/back) ===== */
    .invoice-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin: 12px auto 12px;
      max-width: 900px;
      padding: 0 24px;
    }
    .invoice-actions button{
      padding:10px 16px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-family:inherit;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .invoice-actions button:hover{ background:#f3f6fb; }
    @media print{ .noPrint{ display:none !important; } }

    /* ===== Header: 2 kolumner (logo | meta) ===== */
    .top{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:16px;
      align-items:start;
      border-bottom:2px solid var(--line);
      padding-bottom:14px;
      margin-bottom:16px;
    }
    .logoCol{ min-width:0; }

    /* Meta högerjusterad + indragen */
    .metaCol{
      min-width:0;
      text-align:right;
      padding-right:48px;
    }
    .invTitle{
      margin:0 0 8px;
      font-size:22px;
      line-height:1.1;
    }
    .metaList{ display:grid; gap:6px; }
    .metaRow{ display:flex; gap:10px; justify-content:flex-end; }
    .metaRow .k{ color:var(--muted); font-size:13px; }
    .metaRow .v{ font-weight:700; }

    /* Logga */
    .invoice-logo{
      width:180px;
      height:auto;
      max-width:100%;
      object-fit:contain;
      display:block;
    }
    .logoFallback{
      width:180px;
      padding:10px;
      border:1px dashed var(--line);
      border-radius: var(--r);
      color: var(--muted);
      font-size:12px;
      text-align:center;
    }

    /* ===== Boxes + table ===== */
    .box{ border:1px solid var(--line); border-radius:var(--r); padding:12px; background:#fff; }
    .box h3{ margin:0 0 8px; font-size:14px; }
    .small{ color:var(--muted); font-size:13px; line-height:1.35; margin:0; }

    /* ===== Address: två kolumner i samma ruta ===== */
    .addrBox{ margin:14px 0 18px; }
    .addrGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }
    .addrCol + .addrCol{
      border-left: 1px solid var(--line);
      padding-left: 14px;
    }

    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
    th,td{ border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; vertical-align:top; }
    th{ font-size:13px; color:var(--muted); font-weight:700; }
    td.right, th.right{ text-align:right; }
    td.nowrap{ white-space:nowrap; }

    /* Totalt timmar-rad */
    tr.total-hours td{
      border-bottom: 1px solid var(--line);
      padding-top: 12px;
      padding-bottom: 12px;
      font-weight: 700;
      background: rgba(0,0,0,0.02);
    }

    /* ===== Sum box ===== */
    .sum{ margin-top:14px; display:flex; justify-content:flex-end; }
    .sumBox{ width:380px; border:1px solid var(--line); border-radius:var(--r); padding:12px; background:#fff; }
    .sumRow{ display:flex; justify-content:space-between; gap:12px; margin:6px 0; font-size:14px; }
    .sumRow strong{ font-size:16px; }

    .warn{ margin:10px 0 0; color:#8a1f11; font-size:13px; }

    /* ===== Footer ===== */
    .footer{
      margin-top:18px;
      border-top:1px solid var(--line);
      padding-top:12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .footerInner{
      max-width: 760px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:32px;
    }
    .footerCol{ min-width:0; }
    .footerCol.rightCol{
      text-align:right;
      padding-right:48px;
    }

    /* ===== Mobil (SKÄRM) ===== */
    @media (max-width: 720px){
      .top{ grid-template-columns: 1fr; }
      .metaCol{ text-align:right; padding-right:12px; }
      .metaRow{ justify-content:flex-end; }
      .invoice-logo{ width:160px; }

      /* På skärm i mobil kan adresserna få staplas (det gör inget),
         men i PDF/print kommer vi tvinga två kolumner ändå. */
      .addrGrid{ grid-template-columns: 1fr; }
      .addrCol + .addrCol{
        border-left:0;
        padding-left:0;
        border-top:1px solid var(--line);
        padding-top:12px;
        margin-top:6px;
      }

      .footerInner{ gap:16px; }
      .footerCol.rightCol{ padding-right:12px; }
    }

    /* ===== PRINT / PDF ===== */
    @media print{
      @page{ margin:12mm; }

      body{
        background:#fff !important;
        color:#000 !important;
        display:block !important;      /* <-- viktigt: inga flex-trick i print */
        min-height:auto !important;
      }

      .page{
        max-width:none;
        padding:12mm;
        display:block !important;      /* <-- viktigt */
      }

      /* Header: gör den bred/proportionerlig i print */
      .top{
        grid-template-columns: 1fr 1fr;
        margin-bottom:10mm;
      }
      .metaCol{ padding-right:0; }

      /* Adresser: tvinga 2 kolumner i PDF även på mobil */
      .addrGrid{
        grid-template-columns: 1fr 1fr !important;
      }
      .addrCol + .addrCol{
        border-left:1px solid var(--line) !important;
        border-top:0 !important;
        padding-left:14px !important;
        padding-top:0 !important;
        margin-top:0 !important;
      }

      .addrBox{
        break-inside: avoid;
        page-break-inside: avoid;
        margin: 0 0 8mm;
      }

      table{ margin-top:0; }
      .footer{ margin-top:10mm; }

      /* ===== FIXED FOOTER I PRINT ===== */

      /* Ge plats så innehållet inte hamnar under footern */
      .page{
        padding-bottom: 22mm;   /* justera vid behov (22–35mm) */
       }

      .footer{
        position: fixed;
        left: 12mm;
        right: 12mm;
        bottom: 12mm;

        margin: 0;
        border-top: 1px solid var(--line);
        padding-top: 6mm;
        background: #fff;       /* viktigt i PDF */
      }
 
    }
  </style>
</head>

<body>
  <div class="invoice-actions noPrint">
    <button type="button" id="printBtn" onclick="alert('klick!')">Skriv ut / Spara som PDF</button>

    <button type="button" onclick="history.back()">Tillbaka</button>
  </div>

  <div class="noPrint" style="padding:0 24px; color:#b00; font-weight:700;">
  </div>

  <div class="page">
    <div class="top">
      <div class="logoCol">
        <img
          src="icons/Jubrion_AB_logo_horizontal_192.png"
          alt="Jubrion AB"
          class="invoice-logo"
          onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'logoFallback',textContent:'LOGGA saknas'}))"
        />
      </div>

      <div class="metaCol">
        <h1 class="invTitle">Faktura</h1>
        <div class="metaList">
          <div class="metaRow"><span class="k">Fakturadatum:</span> <span class="v" id="invoiceDate">—</span></div>
          <div class="metaRow"><span class="k">Fakturanummer:</span> <span class="v" id="invoiceNo">—</span></div>
          <div class="metaRow"><span class="k">Period:</span> <span class="v" id="periodLabel">—</span></div>
          <div class="metaRow"><span class="k">Betalningsvillkor:</span> <span class="v">30 dagar</span></div>
        </div>
      </div>
    </div>

    <!-- EN box, två kolumner -->
    <div class="box addrBox">
      <div class="addrGrid">
        <div class="addrCol">
          <h3>Leveransadress</h3>
          <p class="small">
            Mobilaris Industrial Solutions AB<br/>
            Sundsbacken 6<br/>
            972 42 Luleå
          </p>
        </div>

        <div class="addrCol">
          <h3>Fakturaadress</h3>
          <p class="small">mb_22901@xledger.net</p>
        </div>
      </div>
    </div>

    <table aria-label="Fakturarader">
      <thead>
        <tr>
          <th>Beskrivning</th>
          <th class="right nowrap">Antal timmar</th>
          <th class="right nowrap">Á-pris</th>
          <th class="right nowrap">Belopp</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="sum">
      <div class="sumBox">
        <div class="sumRow"><span>Summa exkl. moms</span><span id="sumEx">0 SEK</span></div>
        <div class="sumRow"><span>Moms</span><span id="vat">0 SEK</span></div>
        <div class="sumRow"><strong>Att betala</strong><strong id="total">0 SEK</strong></div>

        <div class="small muted" style="margin-top:6px;">
          Fakturaunderlag kan tillhandahållas på begäran.
        </div>
      </div>
    </div>

    <p class="small muted" style="margin-top:8px;">
      Fakturaunderlag kan tillhandahållas på begäran.
    </p>
    
    <div class="payment-note small" style="margin-top:10px;">
      <strong>Betalningsinformation</strong><br/>
      Bankgiro meddelas så snart bolagsregistrering och bankuppgifter är klara.
      Betalning kan avvaktas till dess.
    </div>
    
    <div class="footer">
      <div class="footerInner">
        <div class="footerCol">
          <div><strong>Jubrion AB</strong></div>
          <div>Tullgatan 17</div>
          <div>972 38 Luleå</div>
        </div>

        <div class="footerCol rightCol">
          <div>Bankgiro: xxxx-xxxx</div>
          <div>F-skatt: SExxxxxxxxxxxx</div>
          <div>E-post: info@jubrion.se</div>
        </div>
      </div>
    </div>

    <div id="warn" class="warn" style="display:none;"></div>
  </div>

<script>
  // ========= Print (mobil): EN binding, synkront =========
  (function () {
    const btn = document.getElementById("printBtn");
    if (!btn) return;

    btn.addEventListener("click", (e) => {
      e.preventDefault();

      const oldTitle = document.title;

      // sätt filnamn via title (vissa mobiler använder title som PDF-namn)
      setPdfTitleForInvoice();

      // VIKTIGT: window.print() direkt i click (ingen requestAnimationFrame)
      window.print();

      // återställ title efteråt
      setTimeout(() => {
        document.title = oldTitle;
      }, 1000);
    }, { passive: false });
  })();

  // ========= Query helpers =========
  const q = new URLSearchParams(location.search);
  const month = (q.get("month") || "").trim();                // "YYYY-MM"
  const rawAccount = (q.get("account") || "all").trim();      // kontoId eller "all"/"ALL"
  const accountParam = rawAccount.toLowerCase() === "all" ? "all" : rawAccount;

  const price = Number(q.get("price") || "650");
  const vatRate = Number(q.get("vat") || "0.25");
  const invNo = (q.get("no") || "2601").trim();

  function safeFilePart(s) {
    return String(s || "")
      .replace(/[\\/:*?"<>|]+/g, "-")
      .replace(/\s+/g, " ")
      .trim();
  }

  function setPdfTitleForInvoice() {
    document.title = `Faktura-${safeFilePart(invNo)} Jubrion AB`;
  }

  const invDate = q.get("date") || (() => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  })();

  // ========= Skriv in meta =========
  document.getElementById("invoiceNo").textContent = invNo;
  document.getElementById("invoiceDate").textContent = invDate;
  document.getElementById("periodLabel").textContent = month ? month : "—";

  // ========= Format =========
  function formatSEK(amount) {
    const n = Number(amount) || 0;
    const fixed = n.toFixed(2);
    const parts = fixed.split(".");
    const intPart = parts[0];
    const decPart = parts[1];
    const spaced = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    return `${spaced},${decPart} SEK`;
  }

  function formatHours(h) {
    const n = Number(h) || 0;
    return n.toFixed(2).replace(".", ",");
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;");
  }

  // ========= Read Timmeloggen data =========
  function loadJSON(key, fallback) {
    try {
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : fallback;
    } catch {
      return fallback;
    }
  }

  const ACC_KEYS = ["tl_accounts_v1", "tl_accounts_v2", "tl_accounts"];
  const DAY_KEYS = ["tl_days_v1", "tl_days_v2", "tl_days"];

  function loadFirst(keys, fallback) {
    for (const k of keys) {
      const v = loadJSON(k, null);
      if (v && (Array.isArray(v) ? v.length : Object.keys(v).length)) {
        return { key: k, value: v };
      }
    }
    return { key: "(ingen)", value: fallback };
  }

  const accRes = loadFirst(ACC_KEYS, []);
  const dayRes = loadFirst(DAY_KEYS, {});
  const accounts = accRes.value || [];
  const days = dayRes.value || {};

  const accNameById = new Map(accounts.map(a => [a.id, a.name]));

  // ========= Time helpers =========
  function parseTimeToMinutes(hhmm) {
    if (!hhmm || typeof hhmm !== "string" || !hhmm.includes(":")) return null;
    const [h, m] = hhmm.split(":").map(x => parseInt(x, 10));
    if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
    return h * 60 + m;
  }

  function slotMinutes(s) {
    if (!s) return 0;

    if (s.durationMin != null) {
      const dm = Number(s.durationMin);
      if (Number.isFinite(dm) && dm > 0) return dm;
    }

    let a = s.startMin ?? null;
    let b = s.endMin ?? null;

    if (a == null || b == null) {
      const sa = s.start ?? s.from ?? s.startTime ?? s.slotStart ?? null;
      const sb = s.end ?? s.to ?? s.endTime ?? s.slotEnd ?? null;
      const pa = parseTimeToMinutes(sa);
      const pb = parseTimeToMinutes(sb);
      if (pa != null && pb != null) { a = pa; b = pb; }
    }

    a = Number(a);
    b = Number(b);
    if (!Number.isFinite(a) || !Number.isFinite(b) || b <= a) return 0;
    return b - a;
  }

  function isBreakSlot(s) {
    return !!(s && (s.isBreak ?? s.break ?? s.isPause));
  }

  // ========= Aggregate minutes per account =========
  const perAccMin = new Map();

  const dayKeys = Object.keys(days)
    .filter(k => month ? k.startsWith(month + "-") : true)
    .sort();

  for (const k of dayKeys) {
    const d = days[k];
    const slots = (d && Array.isArray(d.slots)) ? d.slots : [];
    for (const s of slots) {
      if (isBreakSlot(s)) continue;

      const accId = (s.accountId || "");
      if (accountParam !== "all" && accId !== accountParam) continue;

      const mins = slotMinutes(s);
      if (!mins) continue;

      perAccMin.set(accId, (perAccMin.get(accId) || 0) + mins);
    }
  }

  // ========= Render invoice rows =========
  const rowsEl = document.getElementById("rows");
  let sumEx = 0;
  let totalBillableMinutes = 0;

  const entries = [...perAccMin.entries()]
    .map(([accId, min]) => ({
      accId,
      min,
      name: accNameById.get(accId) || (accId ? accId : "(ej valt)")
    }))
    .sort((a, b) => b.min - a.min);

  if (!entries.length) {
    const warn = document.getElementById("warn");
    warn.style.display = "block";
    warn.textContent = "Inga fakturerbara timmar hittades för vald period/konto.";
    rowsEl.innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
  } else {
    for (const e of entries) {
      totalBillableMinutes += e.min;

      const hours = e.min / 60;
      const amount = hours * price;
      sumEx += amount;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(e.name)}</td>
        <td class="right nowrap">${formatHours(hours)}</td>
        <td class="right nowrap">${formatSEK(price)}</td>
        <td class="right nowrap">${formatSEK(amount)}</td>
      `;
      rowsEl.appendChild(tr);
    }

    // Totalt antal timmar
    const totalHours = totalBillableMinutes / 60;
    const trTot = document.createElement("tr");
    trTot.className = "total-hours";
    trTot.innerHTML = `
      <td>Totalt antal timmar</td>
      <td class="right nowrap">${formatHours(totalHours)}</td>
      <td></td>
      <td></td>
    `;
    rowsEl.appendChild(trTot);
  }

  const vat = sumEx * vatRate;
  const total = sumEx + vat;

  document.getElementById("sumEx").textContent = formatSEK(sumEx);
  document.getElementById("vat").textContent = `${formatSEK(vat)} (${Math.round(vatRate * 100)}%)`;
  document.getElementById("total").textContent = formatSEK(total);
</script>
</body>
</html>
