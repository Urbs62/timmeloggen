<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Faktura – Jubrion AB</title>

  <style>
    :root{
      --text:#111; --muted:#555; --line:#ddd; --bg:#fff;
      --accent:#1e63d5; --r:12px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }
    html,body{ background:var(--bg); color:var(--text); font-family:var(--font); margin:0; }
    .page{ max-width: 900px; margin: 0 auto; padding: 24px; }

    /* Actions (print/back) */
    .invoice-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin: 12px auto 12px;
      max-width: 900px;
      padding: 0 24px;
    }
    .invoice-actions button{
      padding:10px 16px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      font-family:inherit;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .invoice-actions button:hover{ background:#f3f6fb; }
    .invoice-actions button:active{ transform: translateY(1px); }

    @media print{ .noPrint{ display:none !important; } }
    @media print{ .page{ padding:12mm; } @page{ margin:12mm; } }

    /* --- Header: 2 kolumner (logo | meta) --- */
    .top{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:16px;
      align-items:start;
      border-bottom:2px solid var(--line);
      padding-bottom:14px;
      margin-bottom:16px;
    }
    .logoCol{ min-width: 0; }
    .metaCol{ min-width: 0; text-align:right; }

    .invTitle{
      margin:0 0 8px;
      font-size:22px;
      line-height:1.1;
    }
    .metaList{ display:grid; gap:6px; }
    .metaRow{ display:flex; gap:10px; justify-content:flex-end; }
    .metaRow .k{ color:var(--muted); font-size:13px; }
    .metaRow .v{ font-weight:700; }

    .invoice-logo{
      width:180px;
      height:auto;
      max-width:100%;
      object-fit:contain;
      display:block;
    }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin:14px 0 18px; }
    .box{ border:1px solid var(--line); border-radius:var(--r); padding:12px; background:#fff; }
    .box h3{ margin:0 0 8px; font-size:14px; }
    .small{ color:var(--muted); font-size:13px; line-height:1.35; margin:0; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:14px; }
    th,td{ border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; vertical-align:top; }
    th{ font-size:13px; color:var(--muted); font-weight:700; }
    td.right, th.right{ text-align:right; }
    td.nowrap{ white-space:nowrap; }

    .sum{ margin-top:14px; display:flex; justify-content:flex-end; }
    .sumBox{ width:380px; border:1px solid var(--line); border-radius:var(--r); padding:12px; }
    .sumRow{ display:flex; justify-content:space-between; gap:12px; margin:6px 0; font-size:14px; }
    .sumRow strong{ font-size:16px; }

    .warn{ margin:10px 0 0; color:#8a1f11; font-size:13px; }

    /* Footer: 2 kolumner */
    .footer{
      margin-top:18px;
      border-top:1px solid var(--line);
      padding-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:32px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    .footerCol{ min-width:0; }
    .footerCol.rightCol{
      text-align:right;
      padding-right:48px;
    }

    /* Mobil */
    @media (max-width: 720px){
      .top{ grid-template-columns: 1fr; }
      .metaCol{ text-align:left; }
      .metaRow{ justify-content:flex-start; }
      .invoice-logo{ width:160px; }
      .footer{
        grid-template-columns: 1fr 1fr; /* behåll två kolumner */
        gap:16px;
      }
      .footerCol.rightCol{ padding-right:12px; }
      .invoice-actions{ padding: 0 16px; }
      .page{ padding: 16px; }
    }
  </style>
</head>

<body>
  <div class="invoice-actions noPrint">
    <button type="button" id="btnPrint">Skriv ut / Spara som PDF</button>
    <button type="button" id="btnBack">Tillbaka</button>
  </div>

  <div class="page">
    <div class="top">
      <div class="logoCol">
        <img
          src="icons/Jubrion_AB_logo_horizontal_192.png"
          alt="Jubrion AB"
          class="invoice-logo"
          onerror="this.replaceWith(Object.assign(document.createElement('div'),{style:'color:#8a1f11;font-size:12px',textContent:'LOGGA saknas'}))"
        />
      </div>

      <div class="metaCol">
        <h1 class="invTitle">Faktura</h1>
        <div class="metaList">
          <div class="metaRow"><span class="k">Fakturadatum:</span> <span class="v" id="invoiceDate">—</span></div>
          <div class="metaRow"><span class="k">Fakturanummer:</span> <span class="v" id="invoiceNo">—</span></div>
          <div class="metaRow"><span class="k">Period:</span> <span class="v" id="periodLabel">—</span></div>
          <div class="metaRow"><span class="k">Betalningsvillkor:</span> <span class="v">30 dagar</span></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="box">
        <h3>Leveransadress</h3>
        <p class="small">
          Mobilaris Industrial Solutions AB<br/>
          Sundsbacken 6<br/>
          972 42 Luleå
        </p>
      </div>

      <div class="box">
        <h3>Fakturadress</h3>
        <p class="small">info@mobilaris.se</p>
      </div>
    </div>

    <table aria-label="Fakturarader">
      <thead>
        <tr>
          <th>Beskrivning</th>
          <th class="right nowrap">Antal timmar</th>
          <th class="right nowrap">Á-pris</th>
          <th class="right nowrap">Belopp</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="sum">
      <div class="sumBox">
        <div class="sumRow"><span>Summa exkl. moms</span><span id="sumEx">0 SEK</span></div>
        <div class="sumRow"><span>Moms</span><span id="vat">0 SEK</span></div>
        <div class="sumRow"><strong>Att betala</strong><strong id="total">0 SEK</strong></div>
      </div>
    </div>

    <div class="footer">
      <div class="footerCol">
        <div><strong>Jubrion AB</strong></div>
        <div>Tullgatan 17</div>
        <div>972 38 Luleå</div>
      </div>

      <div class="footerCol rightCol">
        <div>Bankgiro: xxxx-xxxx</div>
        <div>F-skatt: AVCFGDRETTT</div>
        <div>E-post: info@jubrionn.se</div>
      </div>
    </div>

    <div id="warn" class="warn" style="display:none;"></div>
  </div>

  <script>
    // --- Robust print för Android/PWA ---
    function isProbablyStandalonePWA(){
      // Android: display-mode standalone
      const dm = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
      // iOS: navigator.standalone
      const ios = !!window.navigator.standalone;
      return !!(dm || ios);
    }

    async function tryPrint(){
      // 1) försök vanlig print
      try{
        window.print();
        return true;
      }catch(e){
        // fortsätt till fallback
      }

      // 2) fallback: öppna i ny flik (brukar ge print-menyn på Android)
      try{
        const url = location.href;
        const w = window.open(url, "_blank");
        if (!w) return false;
        // Låt sidan ladda och försök print i nya tabben
        setTimeout(() => {
          try{ w.focus(); w.print(); }catch(e){}
        }, 700);
        return true;
      }catch(e){
        return false;
      }
    }

    document.getElementById("btnPrint").addEventListener("click", async () => {
      const ok = await tryPrint();
      if (!ok){
        alert("Kunde inte öppna utskrift. Prova öppna sidan i Chrome (inte PWA) och välj Skriv ut där.");
      } else {
        // I PWA kan det fortfarande “kännas” som inget händer.
        // Liten hint om det behövs:
        if (isProbablyStandalonePWA()){
          // inget popup, bara tyst hjälp vid behov
          console.log("Print triggat i PWA-läge.");
        }
      }
    });

    document.getElementById("btnBack").addEventListener("click", () => history.back());

    // ---- Query helpers ----
    const q = new URLSearchParams(location.search);
    const month = (q.get("month") || "").trim();                // "YYYY-MM"
    const rawAccount = (q.get("account") || "all").trim();
    const accountParam = rawAccount.toLowerCase() === "all" ? "all" : rawAccount;

    const price = Number(q.get("price") || "650");
    const vatRate = Number(q.get("vat") || "0.25");
    const invNo = q.get("no") || "1234";
    const invDate = q.get("date") || (() => {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    })();

    document.getElementById("invoiceNo").textContent = invNo;
    document.getElementById("invoiceDate").textContent = invDate;
    document.getElementById("periodLabel").textContent = month ? month : "—";

    // ---- Format ----
    function formatSEK(amount){
      const n = Number(amount) || 0;
      const fixed = n.toFixed(2);
      const [intPart, decPart] = fixed.split(".");
      const spaced = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
      return `${spaced},${decPart} SEK`;
    }
    function formatHours(h){
      const n = Number(h) || 0;
      return n.toFixed(2).replace(".", ",");
    }

    // ---- Read Timmeloggen data from localStorage ----
    function loadJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : fallback;
      }catch{ return fallback; }
    }
    const ACC_KEYS = ["tl_accounts_v1", "tl_accounts_v2", "tl_accounts"];
    const DAY_KEYS = ["tl_days_v1", "tl_days_v2", "tl_days"];

    function loadFirst(keys, fallback){
      for (const k of keys){
        const v = loadJSON(k, null);
        if (v && (Array.isArray(v) ? v.length : Object.keys(v).length)) return { key:k, value:v };
      }
      return { key:"(ingen)", value:fallback };
    }

    const accRes = loadFirst(ACC_KEYS, []);
    const dayRes = loadFirst(DAY_KEYS, {});
    const accounts = accRes.value;
    const days = dayRes.value;

    const accNameById = new Map((accounts || []).map(a => [a.id, a.name]));

    function parseTimeToMinutes(hhmm){
      if (!hhmm || typeof hhmm !== "string" || !hhmm.includes(":")) return null;
      const [h,m] = hhmm.split(":").map(x => parseInt(x,10));
      if (!Number.isFinite(h) || !Number.isFinite(m)) return null;
      return h*60 + m;
    }
    function slotMinutes(s){
      if (!s) return 0;
      if (s.durationMin != null){
        const dm = Number(s.durationMin);
        if (Number.isFinite(dm) && dm > 0) return dm;
      }
      let a = s.startMin ?? null;
      let b = s.endMin ?? null;
      if (a == null || b == null){
        const sa = s.start ?? s.from ?? s.startTime ?? s.slotStart ?? null;
        const sb = s.end   ?? s.to   ?? s.endTime   ?? s.slotEnd   ?? null;
        const pa = parseTimeToMinutes(sa);
        const pb = parseTimeToMinutes(sb);
        if (pa != null && pb != null){ a = pa; b = pb; }
      }
      a = Number(a); b = Number(b);
      if (!Number.isFinite(a) || !Number.isFinite(b) || b <= a) return 0;
      return b - a;
    }
    function isBreakSlot(s){
      return !!(s && (s.isBreak ?? s.break ?? s.isPause));
    }

    const perAccMin = new Map();
    const dayKeys = Object.keys(days || {})
      .filter(k => month ? k.startsWith(month + "-") : true)
      .sort();

    for (const k of dayKeys){
      const d = days[k];
      const slots = (d && Array.isArray(d.slots)) ? d.slots : [];
      for (const s of slots){
        if (isBreakSlot(s)) continue;
        const accId = (s.accountId || "");
        if (accountParam !== "all" && accId !== accountParam) continue;
        const mins = slotMinutes(s);
        if (!mins) continue;
        perAccMin.set(accId, (perAccMin.get(accId) || 0) + mins);
      }
    }

    const rowsEl = document.getElementById("rows");
    let sumEx = 0;

    const entries = [...perAccMin.entries()]
      .map(([accId, min]) => ({
        accId,
        min,
        name: accNameById.get(accId) || (accId ? accId : "(ej valt)")
      }))
      .sort((a,b) => b.min - a.min);

    if (!entries.length){
      const warn = document.getElementById("warn");
      warn.style.display = "block";
      warn.textContent = "Inga fakturerbara timmar hittades för vald period/konto.";
      rowsEl.innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
    } else {
      for (const e of entries){
        const hours = e.min / 60;
        const amount = hours * price;
        sumEx += amount;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${String(e.name).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}</td>
          <td class="right nowrap">${formatHours(hours)}</td>
          <td class="right nowrap">${formatSEK(price)}</td>
          <td class="right nowrap">${formatSEK(amount)}</td>
        `;
        rowsEl.appendChild(tr);
      }
    }

    const vat = sumEx * vatRate;
    const total = sumEx + vat;
    document.getElementById("sumEx").textContent = formatSEK(sumEx);
    document.getElementById("vat").textContent = `${formatSEK(vat)} (${Math.round(vatRate*100)}%)`;
    document.getElementById("total").textContent = formatSEK(total);
  </script>
</body>
</html>
